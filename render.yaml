services:
  - type: web
    name: unityrip
    runtime: node
    plan: standard          # Standard plan = persistent disk available
    region: oregon          # or frankfurt, singapore
    rootDir: backend        # server.js is in /backend

    buildCommand: |
      npm install --production
      apt-get update -qq && apt-get install -y -qq default-jre-headless curl
      mkdir -p /opt/unityrip

      # Download apktool
      curl -fsSL https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar \
        -o /opt/unityrip/apktool.jar

      # Download AssetRipper CLI (cross-platform Unity extractor)
      ARCH=$(uname -m)
      if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
        ARCHIVE="AssetRipper_linux_arm64.tar.bz2"
      else
        ARCHIVE="AssetRipper_linux_x64.tar.bz2"
      fi
      mkdir -p /opt/unityrip/AssetRipper
      curl -fsSL "https://github.com/AssetRipper/AssetRipper/releases/download/0.3.4.0/${ARCHIVE}" \
        -o /tmp/ar.tar.bz2
      tar -xjf /tmp/ar.tar.bz2 -C /opt/unityrip/AssetRipper --strip-components=1
      chmod +x /opt/unityrip/AssetRipper/AssetRipper || true
      rm -f /tmp/ar.tar.bz2

      # Copy frontend into backend/public
      cp -r ../frontend/. ./public/

    startCommand: node server.js

    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: APKTOOL_PATH
        value: /opt/unityrip/apktool.jar
      - key: ASSETSTUDIO_PATH
        value: /opt/unityrip/AssetRipper/AssetRipper
      - key: JAVA_BIN
        value: java
      # Optional: restrict CORS to your domain
      # - key: ALLOWED_ORIGIN
      #   value: https://yourdomain.com

    # Persistent disk to store uploads/jobs between deploys
    disk:
      name: unityrip-data
      mountPath: /var/data
      sizeGB: 10            # Increase if processing large APKs

    healthCheckPath: /health
    autoDeploy: true
